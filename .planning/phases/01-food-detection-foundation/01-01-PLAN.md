---
phase: 01-food-detection-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - training/datasets/scripts/download_datasets.py
  - training/datasets/scripts/merge_datasets.py
  - training/datasets/scripts/auto_label.py
  - training/datasets/scripts/audit_cuisines.py
  - training/configs/food-binary.yaml
  - training/configs/food-detect.yaml
  - training/configs/food-classify.yaml
  - training/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Food-101 and ISIA-500 (or equivalent) classification images are downloaded and organized into ImageNet-style folders"
    - "Bounding box annotations exist for detection training images in YOLO format (class x_center y_center width height)"
    - "Dataset has coverage of Australian/Western AND East Asian cuisines (Chinese, Japanese, Korean, Vietnamese, Thai)"
    - "Binary food/not-food dataset exists with food and non-food image folders"
    - "YOLO dataset config YAML files correctly reference the dataset paths and class lists"
  artifacts:
    - path: "training/datasets/scripts/download_datasets.py"
      provides: "Automated download of Food-101, ISIA-500, and Roboflow food detection datasets"
    - path: "training/datasets/scripts/merge_datasets.py"
      provides: "Merging multiple classification datasets into unified directory structure"
    - path: "training/datasets/scripts/auto_label.py"
      provides: "Florence-2 auto-labeling of classification images to generate YOLO-format bounding boxes"
    - path: "training/datasets/scripts/audit_cuisines.py"
      provides: "Per-cuisine category count and image count report"
    - path: "training/configs/food-detect.yaml"
      provides: "YOLO detection dataset config with train/val/test splits and class names"
    - path: "training/configs/food-classify.yaml"
      provides: "YOLO classification dataset config pointing to merged ImageNet-style folders"
    - path: "training/configs/food-binary.yaml"
      provides: "Binary food/not-food classification dataset config"
  key_links:
    - from: "training/datasets/scripts/auto_label.py"
      to: "training/datasets/food-detection/"
      via: "Writes YOLO-format .txt label files alongside images"
      pattern: "Florence-2.*bounding.*box"
    - from: "training/configs/food-detect.yaml"
      to: "training/datasets/food-detection/"
      via: "path field references dataset root"
      pattern: "path:.*food-detection"
---

<objective>
Acquire, merge, auto-label, and validate training datasets for the three-stage food detection pipeline (binary food/not-food, object detection with bounding boxes, dish classification).

Purpose: Dataset preparation is the hardest and longest-lead-time component of Phase 1 (per research). All downstream model training depends on high-quality, properly formatted datasets with adequate cuisine coverage. This plan creates the complete data pipeline from raw downloads to YOLO-ready training sets.

Output: Downloaded and merged datasets in `training/datasets/`, Florence-2 auto-labeled detection annotations, cuisine audit report, and YOLO config YAML files in `training/configs/`.
</objective>

<execution_context>
@/Users/jting/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jting/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-food-detection-foundation/01-RESEARCH.md
@.planning/phases/01-food-detection-foundation/01-CONTEXT.md
@spike/food-detection-poc/food_detection_spike.ipynb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Download and merge food datasets with cuisine audit</name>
  <files>
    training/requirements.txt
    training/datasets/scripts/download_datasets.py
    training/datasets/scripts/merge_datasets.py
    training/datasets/scripts/audit_cuisines.py
    training/configs/food-binary.yaml
    training/configs/food-classify.yaml
  </files>
  <action>
Create the training environment and dataset pipeline:

1. Create `training/requirements.txt` with dependencies:
   - ultralytics>=8.3.0 (YOLO26 support)
   - torch>=2.0.0
   - torchvision>=0.15.0
   - transformers>=4.36.0 (Florence-2)
   - accelerate>=0.25.0
   - roboflow>=1.1.0
   - Pillow>=10.0.0
   - tqdm
   - coremltools>=7.0

2. Create `training/datasets/scripts/download_datasets.py`:
   - Download Food-101 from HuggingFace (`datasets` library: `load_dataset("ethz/food101")`)
   - Attempt ISIA Food-500 download (http://123.57.42.89 -- may be unreliable). If unavailable, log warning and continue with Food-101 + Roboflow.
   - Download 2-3 food detection datasets from Roboflow Universe that have bounding box annotations (search for "food detection" datasets with >1000 images). Use the `roboflow` Python package.
   - Download a food/not-food binary dataset from Roboflow Universe (search for "food classification" or "food not food").
   - Save all datasets to `training/datasets/raw/` with subdirectories per source.
   - Print summary of downloaded images per dataset and cuisine/category counts.

3. Create `training/datasets/scripts/merge_datasets.py`:
   - Merge Food-101 (+ ISIA-500 if available) into a single ImageNet-style directory structure at `training/datasets/food-classification/` with `train/`, `val/`, `test/` splits (70/15/15).
   - Use consistent lowercase-hyphenated class names (e.g., "pad-thai", "fried-rice", "sushi").
   - Create a class mapping file `training/datasets/food-classification/classes.txt` listing all class names.
   - Merge Roboflow detection datasets into `training/datasets/food-detection/` in YOLO format (images/ and labels/ directories with train/val/test splits).
   - Prepare binary dataset at `training/datasets/food-binary/` with `food/` and `not-food/` subdirectories, split into train/val/test.

4. Create `training/datasets/scripts/audit_cuisines.py`:
   - Categorize each class into cuisine groups: Western, Chinese, Japanese, Korean, Vietnamese, Thai, Indian, Other.
   - Use a hardcoded mapping for well-known dishes (e.g., "sushi" -> Japanese, "pad-thai" -> Thai, "hamburger" -> Western). Use "Other" for ambiguous items.
   - Print a report: per-cuisine category count, total image count, percentage of dataset.
   - Flag if any priority cuisine (Australian/Western, Chinese, Japanese, Korean, Vietnamese, Thai) has <5% representation.
   - Save report to `training/datasets/cuisine_audit_report.txt`.

5. Create `training/configs/food-binary.yaml`:
   ```yaml
   path: ../datasets/food-binary
   train: train
   val: val
   test: test
   nc: 2
   names: ['food', 'not-food']
   ```

6. Create `training/configs/food-classify.yaml`:
   ```yaml
   path: ../datasets/food-classification
   train: train
   val: val
   test: test
   # nc and names will be populated by merge script based on actual class count
   ```

Note: The detection config (food-detect.yaml) is created in Task 2 after auto-labeling generates the detection dataset.
  </action>
  <verify>
- `python training/datasets/scripts/download_datasets.py` completes without errors and `training/datasets/raw/` contains subdirectories with images
- `python training/datasets/scripts/merge_datasets.py` creates `food-classification/`, `food-detection/`, and `food-binary/` directories with train/val/test splits
- `python training/datasets/scripts/audit_cuisines.py` produces a cuisine report showing coverage of priority cuisines
- `training/configs/food-binary.yaml` and `training/configs/food-classify.yaml` exist with valid YAML
- `training/datasets/food-classification/classes.txt` exists with class names
  </verify>
  <done>
- Food-101 (101 classes, ~101K images) downloaded and organized
- At least one Roboflow detection dataset with bounding box annotations downloaded
- Binary food/not-food dataset downloaded and split
- All datasets merged into unified directory structures with train/val/test splits
- Cuisine audit report shows coverage for Western + East Asian cuisines
- YOLO config files created for binary and classification training
  </done>
</task>

<task type="auto">
  <name>Task 2: Auto-label classification images with Florence-2 for detection training</name>
  <files>
    training/datasets/scripts/auto_label.py
    training/configs/food-detect.yaml
  </files>
  <action>
Create the Florence-2 auto-labeling pipeline to generate YOLO-format bounding box annotations from classification images, enabling detection model training on the much larger classification dataset.

1. Create `training/datasets/scripts/auto_label.py`:
   - Load Florence-2-base model from HuggingFace (`microsoft/Florence-2-base`, 0.23B params)
   - Process images from `training/datasets/food-classification/train/` and `val/` directories
   - For each image, run Florence-2 with the `<OD>` (object detection) task token
   - Convert Florence-2 bounding box output to YOLO format: `class_id x_center y_center width height` (all normalized 0-1)
   - Map Florence-2 labels to the class list from `food-classification/classes.txt`. If Florence-2 detects a generic "food" label, use the folder name as the class.
   - Write YOLO-format `.txt` label files to `training/datasets/food-detection-autolabeled/labels/{split}/` with corresponding images symlinked to `training/datasets/food-detection-autolabeled/images/{split}/`
   - Add confidence filtering: skip annotations where Florence-2 confidence < 0.3
   - Add progress bar (tqdm) and batch processing (process N images at a time for GPU efficiency)
   - Log statistics: total images processed, total annotations generated, average annotations per image, images with 0 annotations
   - For images where Florence-2 produces 0 detections, create a single bounding box covering the full image (since Food-101 images are single-food-per-image)

2. Merge auto-labeled data with any Roboflow detection datasets already downloaded:
   - Combine `food-detection-autolabeled/` with `food-detection/` (from Roboflow) into a unified `training/datasets/food-detection-merged/` directory
   - Reconcile class lists between auto-labeled and Roboflow datasets into a single unified class mapping
   - Re-index class IDs in label files to match unified mapping

3. Create `training/configs/food-detect.yaml`:
   ```yaml
   path: ../datasets/food-detection-merged
   train: images/train
   val: images/val
   test: images/test
   nc: <unified_class_count>
   names: <unified_class_list>
   ```

Important notes:
- Florence-2 auto-labeling is GPU-intensive. Use `device="mps"` on macOS (Apple Silicon) or `device="cuda"` if available, falling back to `device="cpu"`.
- Process in batches of 8-16 images to balance memory and throughput.
- This will take significant time (potentially hours for 100K+ images). Add checkpoint/resume capability: track processed images in a JSON file so the script can be restarted without re-processing.
  </action>
  <verify>
- `python training/datasets/scripts/auto_label.py` runs and produces `.txt` label files in YOLO format
- Spot-check 10+ label files: each line has format `class_id x_center y_center width height` with values in [0,1]
- `training/datasets/food-detection-merged/` directory exists with `images/` and `labels/` subdirectories, each having `train/`, `val/`, `test/`
- `training/configs/food-detect.yaml` exists with correct nc and names matching the unified class list
- Auto-label statistics logged: >80% of images should have at least 1 annotation
  </verify>
  <done>
- Florence-2 auto-labeling script generates YOLO-format bounding boxes for classification images
- Auto-labeled detection dataset merged with any Roboflow detection datasets
- Unified food-detect.yaml config references merged dataset with correct class count
- Checkpoint/resume capability allows interrupted runs to continue
  </done>
</task>

</tasks>

<verification>
- All three dataset directories exist: `food-binary/`, `food-classification/`, `food-detection-merged/`
- Each has proper train/val/test splits with images present
- Cuisine audit report confirms coverage of all priority cuisines (Western, Chinese, Japanese, Korean, Vietnamese, Thai)
- All three YOLO config YAML files are valid and reference correct paths
- Detection dataset has YOLO-format bounding box annotations (not just class labels)
</verification>

<success_criteria>
- Datasets downloaded and organized: >50K classification images across >100 food categories
- Auto-labeling complete: >80% of classification images have bounding box annotations
- Priority cuisine coverage: all 6 priority cuisine groups have representation in the dataset
- YOLO config files validated and ready for training
</success_criteria>

<output>
After completion, create `.planning/phases/01-food-detection-foundation/01-01-SUMMARY.md`
</output>
